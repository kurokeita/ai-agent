name: PR Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.1
          registry-url: "https://registry.npmjs.org"

      - name: Cleanup Tags and Versions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          # Use same sanitization logic as version script
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/^-*//;s/-*$//' | tr '[:upper:]' '[:lower:]')

          echo "Cleaning up for branch: $BRANCH_NAME (sanitized: $SANITIZED_BRANCH)"

          # Find tags matching the branch pattern
          # Pattern: v*<sanitized-branch>.*
          # We search for tags containing the sanitized branch name in the prerelease part

          TAGS=$(git tag --list "*-$SANITIZED_BRANCH.*")

          if [ -z "$TAGS" ]; then
            echo "No tags found for this branch."
            exit 0
          fi

          echo "Found tags to delete:"
          echo "$TAGS"

          for TAG in $TAGS; do
            echo "Deleting tag: $TAG"
            
            # Delete local tag
            git tag -d $TAG
            
            # Delete remote tag
            git push origin --delete $TAG || echo "Failed to delete remote tag $TAG"
            
            # Extract version from tag (remove 'v' prefix)
            VERSION=${TAG#v}
            
            # Unpublish from NPM
            # Note: This might fail if the version is too old or if unpublish is restricted
            echo "Attempting to unpublish $VERSION from NPM..."
            npm unpublish "@kurokeita/add-skill@$VERSION" --force || echo "Failed to unpublish $VERSION (might adhere to 72h policy)"
          done
